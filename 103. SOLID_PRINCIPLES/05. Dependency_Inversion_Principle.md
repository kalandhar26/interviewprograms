# Dependency Inversion Principle (DIP)

- Business logic should not depend on payment gateways, databases, or APIs.
- Both should depend on abstractions (interfaces).

## Scenario

### High-level module

- Payment Service : Validates amount, Logs transactions, Coordinates payments & refunds

### Low-level Modules

- Actual payment mechanisms : Stripe, Paypal, Bank Transfer

## BEFORE DIP (Problematic Design)

### High-level module depends on concrete classes

```java
public class PaymentService {

    private final StripePaymentGateway stripeGateway;
    private final PayPalPaymentGateway paypalGateway;

    public PaymentService() {
        this.stripeGateway = new StripePaymentGateway(); // Tight coupling
        this.paypalGateway = new PayPalPaymentGateway(); // Tight coupling
    }

    public void processPayment(String gatewayType, double amount) {

        if ("stripe".equalsIgnoreCase(gatewayType)) {
            stripeGateway.processStripePayment(amount);

        } else if ("paypal".equalsIgnoreCase(gatewayType)) {
            paypalGateway.processPayPalPayment(amount);
        }
    }
}
```

- PaymentService knows too much about low-level details

## AFTER DIP (Correct Design)

### Step 1 : Create Abstraction

```java
public interface PaymentGateway {
    void processPayment(double amount);

    void refundPayment(String transactionId);
}
```

- High-level and low-level modules depend on abstraction.

### Step 2 : Low-Level Modules Implement the Abstraction

- Stripe Implementation

```java
public class StripeGateway implements PaymentGateway {

    @Override
    public void processPayment(double amount) {
        System.out.println("Processing Stripe payment: $" + amount);
    }

    @Override
    public void refundPayment(String transactionId) {
        System.out.println("Refunding Stripe transaction: " + transactionId);
    }
}

```

- PayPal Implementation

```java
public class PayPalGateway implements PaymentGateway {

    @Override
    public void processPayment(double amount) {
        System.out.println("Processing PayPal payment: $" + amount);
    }

    @Override
    public void refundPayment(String transactionId) {
        System.out.println("Refunding PayPal transaction: " + transactionId);
    }
}

```

- Bank Transfer Implementation

```java
public class BankTransferGateway implements PaymentGateway {

    @Override
    public void processPayment(double amount) {
        System.out.println("Processing Bank Transfer: $" + amount);
    }

    @Override
    public void refundPayment(String transactionId) {
        System.out.println("Refunding Bank Transfer: " + transactionId);
    }
}

```

- Low-level modules depend on abstraction, not the other way around.

### Step 3 : High-level Module Depends on Abstraction

```java
public class PaymentService {

    public void processPayment(PaymentGateway gateway, double amount) {

        // Business validation
        if (amount <= 0) {
            throw new IllegalArgumentException("Amount must be positive");
        }

        System.out.println("Initiating payment...");

        // Delegation (runtime polymorphism)
        gateway.processPayment(amount);

        System.out.println("Payment successful");
    }

    public void refundPayment(PaymentGateway gateway, String transactionId) {
        System.out.println("Initiating refund...");
        gateway.refundPayment(transactionId);
        System.out.println("Refund successful");
    }
}

```

- PaymentService knows NOTHING about Stripe / PayPal / Bank Transfer implementations

### Step 4 : Test Client

```java
public class TestPaymentService {

    public static void main(String[] args) {

        PaymentService service = new PaymentService();

        service.processPayment(new StripeGateway(), 100);
        service.processPayment(new PayPalGateway(), 200);
        service.processPayment(new BankTransferGateway(), 300);
    }
}
```

## Real Banking Benefits

✔ Safe gateway replacement
✔ Easy regulatory changes
✔ Simple unit testing with mocks
✔ Clean architecture
✔ Supports microservices & cloud payments
